<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>無人店舗分析ツール</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Plotly / PapaParse（CDN） -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; --ink:#111827; --bg:#fff; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", Arial, sans-serif; margin:16px; color:var(--ink); background:var(--bg); }
    .card { border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; background:#fff; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .full { grid-column:1 / -1; }
    .btn { background:var(--ink); color:#fff; padding:10px 14px; border-radius:8px; border:none; cursor:pointer; }
    .btn.secondary { background:#374151; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn-group { display:flex; gap:8px; flex-wrap:wrap; }
    label { font-weight:700; display:block; margin-bottom:6px; }
    input[type="file"], select, input[type="number"] { padding:8px; border:1px solid var(--border); border-radius:8px; width:100%; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { border-bottom:1px solid #eee; padding:6px 8px; text-align:left; }
    .muted { color:var(--muted); font-size:12px; }
    .error { color:#b91c1c; font-weight:700; white-space:pre-wrap; }
    .metrics { display:flex; gap:12px; flex-wrap:wrap; margin:8px 0; }
    .metric { border:1px solid var(--border); border-radius:10px; padding:8px 12px; background:#fafafa; }
    .kpi-strong { font-weight:800; font-size:16px; }
    /* tabs */
    .tabs { display:flex; gap:8px; margin:12px 0; border-bottom:1px solid var(--border); flex-wrap:wrap; }
    .tab { padding:10px 12px; border:1px solid var(--border); border-bottom:none; border-radius:8px 8px 0 0; background:#f9fafb; cursor:pointer; }
    .tab.active { background:#fff; font-weight:700; }
    .tabcontent { display:none; }
    .tabcontent.active { display:block; }
  </style>
</head>
<body>
  <h1>無人店舗分析ツール</h1>
  <p class="muted">データはブラウザ内でのみ処理され、サーバーへ送信されません。</p>

  <!-- 取込UI -->
  <div class="card">
    <label style="margin-bottom:10px;">csv取り込み</label>
    <div class="btn-group" style="margin-bottom:8px;">
      <button id="pickTx" class="btn">取引毎</button>
      <button id="pickLn" class="btn">商品毎</button>
    </div>
    <div class="btn-group" style="margin-bottom:8px;">
      <button id="pickPm" class="btn secondary">商品マスタ取り込み(csv)</button>
      <span id="status" class="muted" style="align-self:center;">CSVを2つ選択してください</span>
    </div>

    <!-- 実体の file input（非表示） -->
    <input id="txFile" type="file" accept=".csv" style="display:none;" />
    <input id="lnFile" type="file" accept=".csv" style="display:none;" />
    <input id="pmFile" type="file" accept=".csv" style="display:none;" />

    <div class="btn-group" style="margin-top:12px;">
      <button id="runBtn" class="btn" disabled>取り込み & 集計</button>
    </div>
    <p class="muted" style="margin-top:8px;">
      商品マスタの列：<code>JAN</code> / <code>商品名</code> / <code>原価</code> / <code>カテゴリー：小分類コード</code> / <code>カテゴリー：小分類名</code>
      （小分類コードは最大6桁を想定）
    </p>
  </div>

  <!-- タブ -->
  <div class="tabs">
    <div class="tab active" data-tab="previewTab">取り込みデータsummary</div>
    <div class="tab" data-tab="bestTab">ベスレポ集計</div>
    <div class="tab" data-tab="timeTab">時間帯集計</div>
    <div class="tab" data-tab="prodTab">単品分析</div>
    <div class="tab" data-tab="rfmTab">RFM分析</div>
    <div class="tab" data-tab="segTab">セグメント分析</div>
    <div class="tab" data-tab="repeatOnlyTab">リピート分析</div>
    <div class="tab" data-tab="pairOnlyTab">併売分析</div>
  </div>

  <!-- 取り込みデータsummary -->
  <div id="previewTab" class="tabcontent active">
    <div class="card">
      <h2>取り込みサマリー</h2>
      <div class="metrics" id="summary">
        <!-- KPIを描画 -->
      </div>
      <div class="full">
        <div id="preview" class="muted">（先頭50行プレビューを表示）</div>
      </div>
    </div>
  </div>

  <!-- 以降のタブは後続で実装 -->
  <div id="bestTab" class="tabcontent"><div class="card"><p class="muted">ベスレポ集計は後続で実装します。</p></div></div>
  <div id="timeTab" class="tabcontent"><div class="card"><p class="muted">時間帯集計は後続で実装します。</p></div></div>
  <div id="prodTab" class="tabcontent"><div class="card"><p class="muted">単品分析は後続で実装します。</p></div></div>
  <div id="rfmTab" class="tabcontent"><div class="card"><p class="muted">RFM分析は後続で実装します。</p></div></div>
  <div id="segTab" class="tabcontent"><div class="card"><p class="muted">セグメント分析は後続で実装します。</p></div></div>
  <div id="repeatOnlyTab" class="tabcontent"><div class="card"><p class="muted">リピート分析は後続で実装します。</p></div></div>
  <div id="pairOnlyTab" class="tabcontent"><div class="card"><p class="muted">併売分析は後続で実装します。</p></div></div>

  <script>
    // ===== ユーティリティ =====
    const $ = (id) => document.getElementById(id);
    const txInput = $("txFile"), lnInput = $("lnFile"), pmInput = $("pmFile");
    const runBtn  = $("runBtn"), statusEl= $("status");

    // ボタン→ファイル選択
    $("pickTx").addEventListener("click", ()=> txInput.click());
    $("pickLn").addEventListener("click", ()=> lnInput.click());
    $("pickPm").addEventListener("click", ()=> pmInput.click());

    function normalizeHeader(h){ return String(h||"").replace(/\ufeff/g,"").trim(); }
    function parseCSVFile(file){
      return new Promise((resolve,reject)=>{
        Papa.parse(file, {
          header:true, skipEmptyLines:true, encoding:"UTF-8",
          complete: (res)=>{
            const data = res.data.map(row=>{
              const o={};
              Object.keys(row).forEach(k=> o[normalizeHeader(k)] = row[k]);
              return o;
            });
            resolve(data);
          }, error: reject
        });
      });
    }
    function toNumber(x, def=0){
      if (x === null || x === undefined) return def;
      const v = Number(String(x).replace(/,/g,"").trim());
      return isNaN(v) ? def : v;
    }
    function parseDate(s){
      if(!s) return null;
      const t = String(s).trim().replace(/\s+/g," "); // 「2025/8/5  21:53:13」に耐性
      const d = new Date(t);
      return isNaN(d.getTime()) ? null : d;
    }
    function fmtDate(d){ if(!d) return "-"; const m=d.getMonth()+1, day=d.getDate(); return `${d.getFullYear()}/${m}/${day}`; }
    function minDate(arr){ return arr.reduce((a,r)=>(!a||r.生成時間<a? r.生成時間:a), null); }
    function maxDate(arr){ return arr.reduce((a,r)=>(!a||r.生成時間>a? r.生成時間:a), null); }

    function renderTable(rows, elId, cols=null, max=50){
      const el = $(elId);
      if (!rows || rows.length===0){ el.innerHTML = "<p class='muted'>データがありません。</p>"; return; }
      const headers = cols || Object.keys(rows[0]);
      let html = "<table><thead><tr>";
      headers.forEach(h=> html += `<th>${h}</th>`); html += "</tr></thead><tbody>";
      rows.slice(0, max).forEach(r=>{
        html += "<tr>";
        headers.forEach(h=> html += `<td>${r[h] ?? ""}</td>`);
        html += "</tr>";
      });
      html += "</tbody></table>";
      el.innerHTML = html;
    }

    function updateButton(){
      const ok = (txInput.files.length===1 && lnInput.files.length===1);
      runBtn.disabled = !ok;
      statusEl.className = "muted";
      statusEl.textContent = ok ? "準備OK。取り込み＆集計できます。" : "CSVを2つ選択してください";
    }
    txInput.addEventListener("change", updateButton);
    lnInput.addEventListener("change", updateButton);
    pmInput.addEventListener("change", ()=>{/* 任意 */});

    // ===== 状態 =====
    let joined = [];   // JOIN済み明細
    let masterMap = null; // JAN -> {商品名, 原価, 小分類コード, 小分類名}

    // ===== 取り込み & JOIN & サマリー =====
    async function runImport(){
      runBtn.disabled = true;
      statusEl.className = "muted";
      statusEl.textContent = "取り込み中…";

      try{
        const [txRows, lnRows] = await Promise.all([
          parseCSVFile(txInput.files[0]),
          parseCSVFile(lnInput.files[0])
        ]);
        let pmRows = [];
        if (pmInput.files.length===1) pmRows = await parseCSVFile(pmInput.files[0]);

        // 必須列
        const needTx = new Set(["CGID","オーダーID","生成時間"]);
        const needLn = new Set(["CGID","オーダーID","JANコード","商品名","商品数","商品価格","生成時間"]);
        const hasAll=(rows,need)=> rows.length && [...need].every(c=> Object.prototype.hasOwnProperty.call(rows[0],c));
        if(!hasAll(txRows,needTx) || !hasAll(lnRows,needLn)){
          statusEl.className="error";
          statusEl.textContent="必須列が不足（取引毎: CGID, オーダーID, 生成時間 / 商品毎: CGID, オーダーID, JANコード, 商品名, 商品数, 商品価格, 生成時間）";
          return;
        }

        // 整形
        txRows.forEach(r=>{
          r.CGID = String(r.CGID ?? "").trim();
          r.オーダーID = String(r.オーダーID ?? "").trim();
          r.生成時間 = parseDate(r.生成時間);
        });
        lnRows.forEach(r=>{
          r.CGID = String(r.CGID ?? "").trim();
          r.オーダーID = String(r.オーダーID ?? "").trim();
          r.JANコード = String(r.JANコード ?? "").trim();
          r.商品名 = String(r.商品名 ?? "").trim();
          r.生成時間 = parseDate(r.生成時間);
          r.商品数 = Math.trunc(toNumber(r.商品数, 0));
          r.商品価格 = toNumber(r.商品価格, 0);
        });

        // 商品マスタ（任意）
        masterMap = null;
        if (pmRows.length){
          masterMap = new Map();
          pmRows.forEach(r=>{
            const jan = String(r["JAN"] ?? r["JANコード"] ?? "").trim();
            if(!jan) return;
            masterMap.set(jan, {
              商品名: String(r["商品名"] ?? "").trim(),
              原価: toNumber(r["原価"], 0),
              小分類コード: String(r["カテゴリー：小分類コード"] ?? "").trim(),
              小分類名: String(r["カテゴリー：小分類名"] ?? "").trim()
            });
          });
        }

        // JOIN（キー：CGID + オーダーID）…取引毎の生成時間を優先採用
        const txMap = new Map();
        txRows.forEach(r => txMap.set(`${r.CGID}||${r.オーダーID}`, r));

        joined = [];
        for(const r of lnRows){
          const key = `${r.CGID}||${r.オーダーID}`;
          if(!txMap.has(key)) continue;
          const tx = txMap.get(key);

          // マスタ適用
          let 商品名2 = r.商品名;
          let 小分類コード = "", 小分類名 = "", 原価 = 0;
          if (masterMap && masterMap.has(r.JANコード)){
            const m = masterMap.get(r.JANコード);
            if (m.商品名) 商品名2 = m.商品名;
            小分類コード = m.小分類コード || "";
            小分類名   = m.小分類名   || "";
            原価       = toNumber(m.原価, 0);
          }

          const 明細金額 = (r.商品価格 || 0) * (r.商品数 || 0);
          const 明細粗利 = ((r.商品価格 || 0) - (原価 || 0)) * (r.商品数 || 0);

          joined.push({
            CGID: r.CGID,
            オーダーID: r.オーダーID,
            生成時間: tx.生成時間 || r.生成時間,
            JANコード: r.JANコード,
            商品名: 商品名2,
            小分類コード, 小分類名,
            商品数: r.商品数,
            商品価格: r.商品価格,
            原価,
            明細金額,
            明細粗利
          });
        }

        // サマリーKPI
        const uniqUsers = new Set(joined.map(x=>x.CGID)).size;
        const receipts  = new Set(joined.map(x=>x.オーダーID)).size;
        const totalQty  = joined.reduce((s,x)=> s + (x.商品数||0), 0);
        const totalAmt  = joined.reduce((s,x)=> s + (x.明細金額||0), 0);
        const totalGp   = joined.reduce((s,x)=> s + (x.明細粗利||0), 0);
        const dMin = minDate(joined), dMax = maxDate(joined);

        $("summary").innerHTML = `
          <div class="metric">期間: <span class="kpi-strong">${fmtDate(dMin)} ~ ${fmtDate(dMax)}</span></div>
          <div class="metric">ユニークユーザー数: <span class="kpi-strong">${uniqUsers.toLocaleString()}</span></div>
          <div class="metric">レシート件数: <span class="kpi-strong">${receipts.toLocaleString()}</span></div>
          <div class="metric">売上点数合計: <span class="kpi-strong">${totalQty.toLocaleString()}</span></div>
          <div class="metric">売上金額合計: <span class="kpi-strong">${totalAmt.toLocaleString()}</span></div>
          <div class="metric">粗利合計: <span class="kpi-strong">${totalGp.toLocaleString()}</span></div>
        `;

        // プレビュー（先頭50）
        renderTable(
          joined,
          "preview",
          ["CGID","オーダーID","生成時間","JANコード","商品名","小分類コード","小分類名","商品数","商品価格","原価","明細金額","明細粗利"],
          50
        );

        statusEl.className = "muted";
        statusEl.textContent = "完了！";
      }catch(err){
        console.error(err);
        statusEl.className = "error";
        statusEl.textContent = "エラー: " + (err?.message || String(err));
      }finally{
        runBtn.disabled = false;
      }
    }

    // イベント
    $("runBtn").addEventListener("click", runImport);
    function onTabClick(t){
      document.querySelectorAll(".tab,.tabcontent").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      $(t.dataset.tab).classList.add("active");
    }
    document.querySelectorAll(".tab").forEach(t=> t.addEventListener("click", ()=> onTabClick(t)));

    // 初期
    (function init(){
      updateButton();
    })();
  </script>
</body>
</html>
