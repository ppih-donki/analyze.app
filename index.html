<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>無人店舗分析ツール</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- ライブラリ（CDN） -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    :root { --border:#e5e7eb; --muted:#6b7280; --ink:#111827; --bg:#fff; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", Arial, sans-serif; margin:16px; color:var(--ink); background:var(--bg); }
    .card { border:1px solid var(--border); border-radius:12px; padding:16px; margin-bottom:16px; background:#fff; }
    .btn { background:var(--ink); color:#fff; padding:10px 14px; border-radius:8px; border:none; cursor:pointer; }
    .btn.secondary { background:#374151; }
    .btn.ghost { background:#fff; color:var(--ink); border:1px solid var(--border); }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn-group { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    label { font-weight:700; display:block; margin-bottom:6px; }
    input[type="file"] { display:none; }
    .muted { color:var(--muted); font-size:12px; }
    .error { color:#b91c1c; font-weight:700; white-space:pre-wrap; }
    .metrics { display:flex; gap:12px; flex-wrap:wrap; margin:8px 0; }
    .metric { border:1px solid var(--border); border-radius:10px; padding:8px 12px; background:#fafafa; }
    .kpi-strong { font-weight:800; font-size:16px; }
    /* tabs */
    .tabs { display:flex; gap:8px; margin:12px 0; border-bottom:1px solid var(--border); flex-wrap:wrap; }
    .tab { padding:10px 12px; border:1px solid var(--border); border-bottom:none; border-radius:8px 8px 0 0; background:#f9fafb; cursor:pointer; }
    .tab.active { background:#fff; font-weight:700; }
    .tabcontent { display:none; }
    .tabcontent.active { display:block; }
    table { width:100%; border-collapse:collapse; font-size:14px; }
    th, td { border-bottom:1px solid #eee; padding:6px 8px; text-align:left; }
    .diag { margin-top:8px; padding:8px 10px; border:1px dashed var(--border); border-radius:8px; background:#fafafa; }
    .fname { font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:6px; background:#fafafa; }
    .fileline { display:flex; align-items:center; gap:8px; }
    .form-row { display:flex; gap:12px; flex-wrap:wrap; align-items:end; margin-bottom:12px; }
    .form-row > div { display:flex; flex-direction:column; gap:6px; }
    select, input[type="date"] { padding:8px 10px; border:1px solid var(--border); border-radius:8px; min-width:180px; }
  </style>
</head>
<body>
  <h1>無人店舗分析ツール</h1>
  <p class="muted">データはブラウザ内でのみ処理され、サーバーへ送信されません。</p>

  <!-- 取込UI -->
  <div class="card">
    <label style="margin-bottom:10px;">csv取り込み</label>

    <div class="btn-group" style="margin-bottom:6px;">
      <div class="fileline">
        <button id="pickTx" class="btn">取引毎</button>
        <span id="fnameTx" class="fname muted">未選択</span>
      </div>

      <div class="fileline">
        <button id="pickLn" class="btn">商品毎</button>
        <span id="fnameLn" class="fname muted">未選択</span>
      </div>

      <div class="fileline">
        <button id="pickPm" class="btn secondary">商品マスタ取り込み(csv)</button>
        <span id="fnamePm" class="fname muted">未選択</span>
      </div>

      <span id="status" class="muted" style="margin-left:auto;"></span>
    </div>

    <!-- 実体の file input -->
    <input id="txFile" type="file" accept=".csv" />
    <input id="lnFile" type="file" accept=".csv" />
    <input id="pmFile" type="file" accept=".csv" />

    <div class="btn-group" style="margin-top:8px;">
      <button id="runBtn" class="btn" disabled>集計を実行する</button>
      <span id="catStatus" class="muted">カテゴリマスタ：取得済み</span>
    </div>

    <p class="muted" style="margin-top:8px;">
      商品マスタCSVの列：<code>商品コード</code> / <code>商品分類</code> / <code>商品名</code>（<code>商品名規格</code>があれば代用）/ <code>POS原価</code>（※ExcelのM列）
    </p>
  </div>

  <!-- タブ -->
  <div class="tabs">
    <div class="tab active" data-tab="previewTab">取り込みデータsummary</div>
    <div class="tab" data-tab="bestTab">ベスレポ集計</div>
    <div class="tab" data-tab="timeTab">時間帯集計</div>
    <div class="tab" data-tab="prodTab">単品分析</div>
    <div class="tab" data-tab="rfmTab">RFM分析</div>
    <div class="tab" data-tab="segTab">セグメント分析</div>
    <div class="tab" data-tab="repeatOnlyTab">リピート分析</div>
    <div class="tab" data-tab="pairOnlyTab">併売分析</div>
  </div>

  <!-- 取り込みデータsummary -->
  <div id="previewTab" class="tabcontent active">
    <div class="card">
      <h2>取り込みサマリー</h2>
      <div class="metrics" id="summary"></div>
      <div class="diag" id="masterDiag" style="display:none;"></div>
      <div id="preview" class="muted">（先頭50行プレビューを表示）</div>
    </div>
  </div>

  <!-- ベスレポ集計 -->
  <div id="bestTab" class="tabcontent">
    <div class="card">
      <h2>ベスレポ集計</h2>
      <div class="form-row">
        <div>
          <label>開始日</label>
          <input type="date" id="bestStart" />
        </div>
        <div>
          <label>終了日</label>
          <input type="date" id="bestEnd" />
        </div>
        <div>
          <label>ランキング軸</label>
          <select id="bestMetric">
            <option value="amt">売上順（明細金額合計）</option>
            <option value="qty">点数順（販売数量合計）</option>
            <option value="gp">粗利順（粗利合計）</option>
            <option value="uniq">購買ユニークユーザー数順</option>
            <option value="repeat">リピートユーザー数順（同一JANを2回以上）</option>
          </select>
        </div>
        <div class="btn-group">
          <button id="bestRun" class="btn">この条件で集計</button>
          <button id="bestExport" class="btn ghost" disabled>CSVエクスポート</button>
        </div>
      </div>
      <div id="bestInfo" class="muted" style="margin-bottom:8px;"></div>
      <div id="bestTable"></div>
    </div>
  </div>

  <!-- 他タブはプレースホルダ -->
  <div id="timeTab" class="tabcontent"><div class="card"><p class="muted">時間帯集計は後続で実装します。</p></div></div>
  <div id="prodTab" class="tabcontent"><div class="card"><p class="muted">単品分析は後続で実装します。</p></div></div>
  <div id="rfmTab" class="tabcontent"><div class="card"><p class="muted">RFM分析は後続で実装します。</p></div></div>
  <div id="segTab" class="tabcontent"><div class="card"><p class="muted">セグメント分析は後続で実装します。</p></div></div>
  <div id="repeatOnlyTab" class="tabcontent"><div class="card"><p class="muted">リピート分析は後続で実装します。</p></div></div>
  <div id="pairOnlyTab" class="tabcontent"><div class="card"><p class="muted">併売分析は後続で実装します。</p></div></div>

  <script>
    /** 固定カテゴリ（小分類）マスタURL */
    const CATEGORY_TXT_URL = "https://ppih-donki.github.io/analyze.app/data/category.txt";

    // ===== ユーティリティ =====
    const $ = (id) => document.getElementById(id);

    // 全角→半角 / トリム
    function toNarrow(str){
      if (str == null) return "";
      return String(str)
        .replace(/\ufeff/g,"")
        .replace(/\u3000/g," ")
        .replace(/[\uFF01-\uFF5E]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
        .trim();
    }
    // 比較用のノーマライズ（小文字化＋スペース除去）
    function keyNorm(s){
      return toNarrow(s).toLowerCase().replace(/\s+/g,"");
    }

    function parseCSVFile(file){
      return new Promise((resolve,reject)=>{
        Papa.parse(file, {
          header:true, skipEmptyLines:true, encoding:"UTF-8",
          complete: (res)=>{
            const headers = res.meta.fields.map(h=>toNarrow(h)); // 表示キーは「半角＆トリム」のヘッダ
            const data = res.data.map(row=>{
              const o={};
              res.meta.fields.forEach((raw,i)=>{
                const normalized = headers[i]; // ノーマライズ済みの見出しで格納
                o[normalized] = row[raw];
              });
              return o;
            });
            resolve({ data, headers });
          }, error: reject
        });
      });
    }

    // 通貨・単価文字列に強い数値化
    function toNumber(x, def=0){
      if (x === null || x === undefined) return def;
      let s = String(x);
      // 全角→半角・不要文字除去
      s = toNarrow(s).replace(/[^\d.\-]/g, "");
      if (!s) return def;
      const v = Number(s);
      return isNaN(v) ? def : v;
    }

    function parseDate(s){
      if(!s) return null;
      const t = toNarrow(s).replace(/\s+/g," ");
      const d = new Date(t);
      return isNaN(d.getTime()) ? null : d;
    }
    const fmtDate = (d)=> !d ? "-" : `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    const fmtDateSlash = (d)=> !d ? "-" : `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
    const minDate = (arr)=> arr.reduce((a,r)=>(!a||r.生成時間<a? r.生成時間:a), null);
    const maxDate = (arr)=> arr.reduce((a,r)=>(!a||r.生成時間>a? r.生成時間:a), null);

    function renderTable(rows, elId, cols=null, max=null){
      const el = $(elId);
      if (!el) return;
      if (!rows || rows.length===0){ el.innerHTML = "<p class='muted'>データがありません。</p>"; return; }
      const headers = cols || Object.keys(rows[0]);
      let html = "<table><thead><tr>";
      headers.forEach(h=> html += `<th>${h}</th>`); html += "</tr></thead><tbody>";
      const view = max ? rows.slice(0, max) : rows;
      view.forEach(r=>{
        html += "<tr>";
        headers.forEach(h=> html += `<td>${r[h] ?? ""}</td>`);
        html += "</tr>";
      });
      html += "</tbody></table>";
      el.innerHTML = html;
    }

    // ===== 状態 =====
    let els = {};
    let joined = [];
    let masterMap = null;   // JAN -> {商品名, 商品分類(小分類コード), POS原価}
    let categoryMap = null; // 小分類コード -> 小分類名

    // ベスレポの保持（エクスポート用）
    let lastBestList = null;
    let lastBestMeta = null; // {start,end,label}

    // ===== カテゴリマスタ自動読込 =====
    async function autoLoadCategory(){
      const badge = els.catStatus;
      try{
        const res = await fetch(CATEGORY_TXT_URL, { mode:"cors", cache:"no-store" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        categoryMap = parseCategoryTxt(text);
        if (badge){ badge.className="muted"; badge.textContent = "カテゴリマスタ：GitHubから読込済み"; }
      }catch(e){
        if (badge){ badge.className="error"; badge.textContent = "カテゴリtxtの取得に失敗: " + (e?.message||e); }
      }
    }

    function parseCategoryTxt(text){
      const lines = String(text).split(/\r?\n/);
      const map = new Map();
      for (const line of lines){
        const raw = toNarrow(line);
        if (!raw) continue;
        let parts = raw.split("\t");
        if (parts.length < 2) parts = raw.split(/\s+/);
        if (parts.length < 2) continue;
        const code = parts[0];
        const name = parts.slice(1).join(" ");
        if (!/^\d{3,}$/.test(code)) continue;
        map.set(code, name);
      }
      return map;
    }

    // === ヘッダ探索（候補名 or 位置で決定） ===
    function findHeader(headers, candidates){
      const normHeaders = headers.map(h=>keyNorm(h));
      for (const cand of candidates){
        const k = keyNorm(cand);
        const idx = normHeaders.indexOf(k);
        if (idx !== -1) return headers[idx];
      }
      return null;
    }

    function buildMasterMap(pm){
      const { data: pmRows, headers } = pm;
      const map = new Map();

      const codeCands = ["商品コード","商品cd","jan","janコード","バーコード","コード"];
      const catCands  = ["商品分類","小分類","小分類コード","分類"];
      const nameCands = ["商品名","商品名規格","品名","商品名称"];
      const costCands = ["pos原価","pos 原価","ｐｏｓ原価","原価","仕入原価","pos原価(税抜)","原価(税抜)"];

      const codeHdr = findHeader(headers, codeCands);
      const catHdr  = findHeader(headers, catCands);
      const nameHdr = findHeader(headers, nameCands);
      let   costHdr = findHeader(headers, costCands);

      if (!costHdr && headers.length > 12) costHdr = headers[12]; // M列

      for (const r of pmRows){
        const code = toNarrow(codeHdr ? r[codeHdr] : "").trim();
        if (!code) continue;

        const nm   = toNarrow(nameHdr ? r[nameHdr] : "") || "";
        const cat  = toNarrow(catHdr ? r[catHdr] : "") || "";

        let cost = 0;
        if (costHdr && r.hasOwnProperty(costHdr)) cost = toNumber(r[costHdr], 0);

        map.set(code, { 商品名: nm, 商品分類: cat, POS原価: cost });
      }
      return map;
    }

    // ===== 取り込み & JOIN & サマリー =====
    async function runImport(){
      const statusEl = els.status; const runBtn = els.runBtn;
      if (runBtn) runBtn.disabled = true;
      if (statusEl){ statusEl.className = "muted"; statusEl.textContent = "取り込み中…"; }

      try{
        const [tx, ln] = await Promise.all([
          parseCSVFile(els.txInput.files[0]),
          parseCSVFile(els.lnInput.files[0])
        ]);
        let pm = null;
        if (els.pmInput.files.length===1) pm = await parseCSVFile(els.pmInput.files[0]);

        const txRows = tx.data, lnRows = ln.data;

        const needTx = new Set(["CGID","オーダーID","生成時間"].map(toNarrow));
        const needLn = new Set(["CGID","オーダーID","JANコード","商品名","商品数","商品価格","生成時間"].map(toNarrow));
        const hasAll=(rows,need)=> rows.length && [...need].every(c=> Object.prototype.hasOwnProperty.call(rows[0],c));
        if(!hasAll(txRows,needTx) || !hasAll(lnRows,needLn)){
          if (statusEl){ statusEl.className="error"; statusEl.textContent="必須列が不足（取引毎: CGID, オーダーID, 生成時間 / 商品毎: CGID, オーダーID, JANコード, 商品名, 商品数, 商品価格, 生成時間）"; }
          return;
        }

        txRows.forEach(r=>{
          r.CGID = toNarrow(r.CGID);
          r.オーダーID = toNarrow(r.オーダーID);
          r.生成時間 = parseDate(r.生成時間);
        });
        lnRows.forEach(r=>{
          r.CGID = toNarrow(r.CGID);
          r.オーダーID = toNarrow(r.オーダーID);
          r.JANコード = toNarrow(r.JANコード);
          r.商品名 = toNarrow(r.商品名);
          r.生成時間 = parseDate(r.生成時間);
          r.商品数 = Math.trunc(toNumber(r.商品数, 0));
          r.商品価格 = toNumber(r.商品価格, 0);
        });

        masterMap = null;
        let masterInfoText = "商品マスタ：未読込（原価=0扱い）";
        if (pm){
          masterMap = buildMasterMap(pm);
          masterInfoText = `商品マスタ：${pm.data.length.toLocaleString()}行（JANキー: ${masterMap.size.toLocaleString()}件）`;
        }

        const txMap = new Map();
        txRows.forEach(r => txMap.set(`${r.CGID}||${r.オーダーID}`, r));

        joined = [];
        let matched = 0;
        const unmatchedJAN = new Map();

        for(const r of lnRows){
          const key = `${r.CGID}||${r.オーダーID}`;
          if(!txMap.has(key)) continue;
          const txRec = txMap.get(key);

          let 商品名2 = r.商品名;
          let 商品分類 = "";
          let 小分類名 = "";
          let 原価 = 0;

          if (masterMap && masterMap.has(r.JANコード)){
            const m = masterMap.get(r.JANコード);
            if (m.商品名) 商品名2 = m.商品名;
            商品分類 = m.商品分類 || "";
            原価 = toNumber(m.POS原価, 0);
            matched++;
          } else if (masterMap){
            unmatchedJAN.set(r.JANコード, (unmatchedJAN.get(r.JANコード)||0)+1);
          }

          if (categoryMap && 商品分類){
            小分類名 = categoryMap.get(商品分類) || "";
          }

          const 明細金額 = (r.商品価格 || 0) * (r.商品数 || 0);
          const 明細粗利 = ((r.商品価格 || 0) - (原価 || 0)) * (r.商品数 || 0);

          joined.push({
            CGID: r.CGID,
            オーダーID: r.オーダーID,
            生成時間: txRec.生成時間 || r.生成時間,
            JANコード: r.JANコード,
            商品名: 商品名2,
            商品分類,
            小分類名,
            商品数: r.商品数,
            商品価格: r.商品価格,
            POS原価: 原価,
            明細金額,
            明細粗利
          });
        }

        const uniqUsers = new Set(joined.map(x=>x.CGID)).size;
        const receipts  = new Set(joined.map(x=>x.オーダーID)).size;
        const totalQty  = joined.reduce((s,x)=> s + (x.商品数||0), 0);
        const totalAmt  = joined.reduce((s,x)=> s + (x.明細金額||0), 0);
        const totalGp   = joined.reduce((s,x)=> s + (x.明細粗利||0), 0);
        const dMin = minDate(joined), dMax = maxDate(joined);

        $("summary").innerHTML = `
          <div class="metric">期間: <span class="kpi-strong">${fmtDateSlash(dMin)} ~ ${fmtDateSlash(dMax)}</span></div>
          <div class="metric">ユニークユーザー数: <span class="kpi-strong">${uniqUsers.toLocaleString()}</span></div>
          <div class="metric">レシート件数: <span class="kpi-strong">${receipts.toLocaleString()}</span></div>
          <div class="metric">売上点数合計: <span class="kpi-strong">${totalQty.toLocaleString()}</span></div>
          <div class="metric">売上金額合計: <span class="kpi-strong">${totalAmt.toLocaleString()}</span></div>
          <div class="metric">粗利合計: <span class="kpi-strong">${totalGp.toLocaleString()}</span></div>
        `;

        // ベスレポの日付UIを初期化
        if (dMin && dMax){
          $("bestStart").min = $("bestEnd").min = fmtDate(dMin);
          $("bestStart").max = $("bestEnd").max = fmtDate(dMax);
          $("bestStart").value = fmtDate(dMin);
          $("bestEnd").value   = fmtDate(dMax);
        }

        const diag = $("masterDiag");
        const rate = joined.length ? Math.round((matched / joined.length) * 100) : 0;
        let topUnmatched = "";
        if (unmatchedJAN.size){
          const arr = Array.from(unmatchedJAN.entries()).sort((a,b)=> b[1]-a[1]).slice(0,10);
          topUnmatched = "<br>未マッチJAN上位: " + arr.map(([jan,c])=> `${jan}(${c})`).join(", ");
        }
        diag.style.display = "block";
        diag.innerHTML = `${masterInfoText} / 明細行: ${joined.length.toLocaleString()} / マスタ適用: ${matched.toLocaleString()}（${rate}%）${topUnmatched}`;

        renderTable(
          joined,
          "preview",
          ["CGID","オーダーID","生成時間","JANコード","商品名","商品分類","小分類名","商品数","商品価格","POS原価","明細金額","明細粗利"],
          50
        );

        if (statusEl){ statusEl.className = "muted"; statusEl.textContent = "完了！"; }
      }catch(err){
        console.error(err);
        if (statusEl){ statusEl.className = "error"; statusEl.textContent = "エラー: " + (err?.message || String(err)); }
      }finally{
        if (runBtn) runBtn.disabled = false;
      }
    }

    // ===== ベスレポ集計 =====
    function computeBestReport(){
      if (!joined.length){
        $("bestInfo").textContent = "先にCSVを取り込んでください。";
        $("bestTable").innerHTML = "";
        $("bestExport").disabled = true;
        lastBestList = null; lastBestMeta = null;
        return;
      }
      const s = $("bestStart").value;
      const e = $("bestEnd").value;
      const metric = $("bestMetric").value;

      const sDate = s ? new Date(s+"T00:00:00") : null;
      const eDate = e ? new Date(e+"T23:59:59") : null;

      const rows = joined.filter(r=>{
        if (!r.生成時間) return false;
        if (sDate && r.生成時間 < sDate) return false;
        if (eDate && r.生成時間 > eDate) return false;
        return true;
      });

      const byJan = new Map();
      for (const r of rows){
        const k = r.JANコード || "-";
        if (!byJan.has(k)){
          byJan.set(k, {
            JANコード: k,
            商品名: r.商品名 || "",
            小分類名: r.小分類名 || "",
            売上金額合計: 0,
            売上点数合計: 0,
            粗利合計: 0,
            ユーザーset: new Set(),
            userCnt: new Map(),
          });
        }
        const o = byJan.get(k);
        o.売上金額合計 += (r.明細金額 || 0);
        o.売上点数合計 += (r.商品数 || 0);
        o.粗利合計   += (r.明細粗利 || 0);
        if (r.CGID){
          o.ユーザーset.add(r.CGID);
          o.userCnt.set(r.CGID, (o.userCnt.get(r.CGID) || 0) + (r.商品数 || 0));
        }
      }

      const list = [];
      for (const o of byJan.values()){
        const repeatUsers = Array.from(o.userCnt.values()).filter(cnt => cnt >= 2).length;
        list.push({
          JANコード: o.JANコード,
          商品名: o.商品名,
          小分類名: o.小分類名,
          売上金額合計: Math.round(o.売上金額合計),
          売上点数合計: Math.round(o.売上点数合計),
          粗利合計: Math.round(o.粗利合計),
          購買ユニークユーザー数: o.ユーザーset.size,
          リピートユーザー数: repeatUsers
        });
      }

      const keyMap = {
        amt: "売上金額合計",
        qty: "売上点数合計",
        gp:  "粗利合計",
        uniq:"購買ユニークユーザー数",
        repeat:"リピートユーザー数",
      };
      const metricLabelMap = {
        amt:"売上ベスレポ",
        qty:"点数ベスレポ",
        gp:"粗利ベスレポ",
        uniq:"ユニークユーザー数ベスレポ",
        repeat:"リピートベスレポ"
      };
      const sortKey = keyMap[metric] || "売上金額合計";
      const label  = metricLabelMap[metric] || "売上ベスレポ";
      list.sort((a,b)=> b[sortKey] - a[sortKey]);

      $("bestInfo").textContent = `期間: ${s || "-"} ~ ${e || "-"} / 件数: ${list.length.toLocaleString()} / 並び順: ${$("bestMetric").selectedOptions[0].textContent}`;
      renderTable(
        list,
        "bestTable",
        ["JANコード","商品名","小分類名","売上金額合計","売上点数合計","粗利合計","購買ユニークユーザー数","リピートユーザー数"],
        null
      );

      // エクスポート用に保持
      lastBestList = list;
      lastBestMeta = { start: s || "", end: e || "", label };
      $("bestExport").disabled = !lastBestList || lastBestList.length===0;
    }

    // ===== ベスレポ CSVエクスポート =====
    function exportBestCSV(){
      if (!lastBestList || !lastBestList.length) return;
      const headers = ["JANコード","商品名","小分類名","売上金額合計","売上点数合計","粗利合計","購買ユニークユーザー数","リピートユーザー数"];

      // 1行目（ヘッダ）： yyyy/mm/dd ~ yyyy/mm/dd + レポート名
      const ymd = (s)=> s ? s.replaceAll("-", "/") : "-";
      const preface = `${ymd(lastBestMeta.start)} ~ ${ymd(lastBestMeta.end)} ${lastBestMeta.label}`;

      // CSV生成
      const lines = [];
      lines.push(preface);
      lines.push(headers.join(","));
      for (const r of lastBestList){
        const row = headers.map(h=>{
          let v = r[h];
          // CSVエスケープ
          if (v === null || v === undefined) v = "";
          v = String(v).replaceAll('"','""');
          if (/[",\n]/.test(v)) v = `"${v}"`;
          return v;
        });
        lines.push(row.join(","));
      }
      const csv = "\uFEFF" + lines.join("\n");

      // ファイル名：YYYY-MM-DD_YYYY-MM-DD_レポート名.csv
      const fn = `${lastBestMeta.start || "all"}_${lastBestMeta.end || "all"}_${lastBestMeta.label}.csv`;

      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = fn;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function updateButton(){
      const ok = (els.txInput?.files?.length===1 && els.lnInput?.files?.length===1);
      if (els.runBtn) els.runBtn.disabled = !ok;
      if (els.status){
        els.status.className = "muted";
        els.status.textContent = ok ? "準備OK。取り込み＆集計できます。" : "CSVを2つ選択してください";
      }
      $("fnameTx").textContent = els.txInput?.files?.[0]?.name || "未選択";
      $("fnameTx").classList.toggle("muted", !els.txInput?.files?.length);
      $("fnameLn").textContent = els.lnInput?.files?.[0]?.name || "未選択";
      $("fnameLn").classList.toggle("muted", !els.lnInput?.files?.length);
      $("fnamePm").textContent = els.pmInput?.files?.[0]?.name || "未選択";
      $("fnamePm").classList.toggle("muted", !els.pmInput?.files?.length);
    }

    function onTabClick(t){
      document.querySelectorAll(".tab,.tabcontent").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const pane = document.getElementById(t.dataset.tab);
      if (pane) pane.classList.add("active");
    }

    // ===== 初期化 =====
    document.addEventListener("DOMContentLoaded", async ()=>{
      els = {
        pickTx: $("pickTx"),
        pickLn: $("pickLn"),
        pickPm: $("pickPm"),
        txInput: $("txFile"),
        lnInput: $("lnFile"),
        pmInput: $("pmFile"),
        runBtn: $("runBtn"),
        status: $("status"),
        catStatus: $("catStatus"),
      };

      // ファイルピッカー
      els.pickTx?.addEventListener("click", ()=> els.txInput?.click());
      els.pickLn?.addEventListener("click", ()=> els.lnInput?.click());
      els.pickPm?.addEventListener("click", ()=> els.pmInput?.click());

      els.txInput?.addEventListener("change", updateButton);
      els.lnInput?.addEventListener("change", updateButton);
      els.pmInput?.addEventListener("change", updateButton);

      // タブ
      document.querySelectorAll(".tab").forEach(t=> t.addEventListener("click", ()=> onTabClick(t)));

      // カテゴリマスタ
      await autoLoadCategory();

      // 取り込み
      els.runBtn?.addEventListener("click", runImport);

      // ベスレポ
      $("bestRun")?.addEventListener("click", computeBestReport);
      $("bestExport")?.addEventListener("click", exportBestCSV);

      updateButton();
    });
  </script>
</body>
</html>
